name: Publica√ß√£o Autom√°tica de Loterias

on:
  workflow_dispatch:
  schedule:
    # Executa diariamente √†s 22:45 UTC (‚âà 19:45 Bras√≠lia; aten√ß√£o a hor√°rio de ver√£o)
    - cron: "45 22 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt --no-cache-dir

      - name: Verificar pend√™ncias
        env:
          GOOGLE_SERVICE_JSON: ${{ secrets.GOOGLE_SERVICE_JSON }}

          # Conta 1 (OBRIGAT√ìRIA)
          TWITTER_API_KEY_1: ${{ secrets.TWITTER_API_KEY_1 }}
          TWITTER_API_SECRET_1: ${{ secrets.TWITTER_API_SECRET_1 }}
          TWITTER_ACCESS_TOKEN_1: ${{ secrets.TWITTER_ACCESS_TOKEN_1 }}
          TWITTER_ACCESS_TOKEN_SECRET_1: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET_1 }}

          # Conta 2 (OPCIONAL)
          TWITTER_API_KEY_2: ${{ secrets.TWITTER_API_KEY_2 }}
          TWITTER_API_SECRET_2: ${{ secrets.TWITTER_API_SECRET_2 }}
          TWITTER_ACCESS_TOKEN_2: ${{ secrets.TWITTER_ACCESS_TOKEN_2 }}
          TWITTER_ACCESS_TOKEN_SECRET_2: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET_2 }}

          # Configura√ß√£o do bot
          BACKLOG_DAYS: ${{ secrets.BACKLOG_DAYS }}
          MAX_TWEETS_PER_RUN: ${{ secrets.MAX_TWEETS_PER_RUN }}
          RATE_DELAY_SECONDS: ${{ secrets.RATE_DELAY_SECONDS }}
          RATE_BACKOFF_SECONDS: ${{ secrets.RATE_BACKOFF_SECONDS }}
          LOOP_MODE: ${{ secrets.LOOP_MODE }}
        run: |
          echo "üîé Verificando vari√°veis de ambiente (sem exibir valores)..."
          python - <<'PY'
          import os, sys

          def is_set(k: str) -> bool:
            v = os.getenv(k)
            return bool(v and str(v).strip())

          missing = []

          # Obrigat√≥rias (Conta 1 + Google)
          required = [
            "GOOGLE_SERVICE_JSON",
            "TWITTER_API_KEY_1", "TWITTER_API_SECRET_1",
            "TWITTER_ACCESS_TOKEN_1", "TWITTER_ACCESS_TOKEN_SECRET_1",
          ]
          for k in required:
            if not is_set(k):
              missing.append(k)

          if missing:
            print("‚ùå Faltam vari√°veis obrigat√≥rias:", missing)
            sys.exit(1)

          # Conta 2: se estiver parcial, apenas avisa e ignora (n√£o falha)
          c2 = [
            "TWITTER_API_KEY_2", "TWITTER_API_SECRET_2",
            "TWITTER_ACCESS_TOKEN_2", "TWITTER_ACCESS_TOKEN_SECRET_2",
          ]
          c2_set = [k for k in c2 if is_set(k)]
          if c2_set and len(c2_set) != len(c2):
            print("‚ö†Ô∏è Conta #2 parcialmente configurada. Ser√° IGNORADA.")
            print("   Presentes:", c2_set)
            print("   Faltando:", [k for k in c2 if k not in c2_set])
          elif len(c2_set) == len(c2) and c2_set:
            print("‚úÖ Conta #2: configurada (todas as vari√°veis presentes).")
          else:
            print("‚ÑπÔ∏è Conta #2: n√£o configurada (ser√° ignorada).")

          print("‚úÖ Todas as vari√°veis obrigat√≥rias est√£o presentes.")
          PY

      - name: Executar o bot
        env:
          GOOGLE_SERVICE_JSON: ${{ secrets.GOOGLE_SERVICE_JSON }}

          # Conta 1 (OBRIGAT√ìRIA)
          TWITTER_API_KEY_1: ${{ secrets.TWITTER_API_KEY_1 }}
          TWITTER_API_SECRET_1: ${{ secrets.TWITTER_API_SECRET_1 }}
          TWITTER_ACCESS_TOKEN_1: ${{ secrets.TWITTER_ACCESS_TOKEN_1 }}
          TWITTER_ACCESS_TOKEN_SECRET_1: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET_1 }}

          # Conta 2 (OPCIONAL ‚Äî se estiver parcial, o bot deve ignorar)
          TWITTER_API_KEY_2: ${{ secrets.TWITTER_API_KEY_2 }}
          TWITTER_API_SECRET_2: ${{ secrets.TWITTER_API_SECRET_2 }}
          TWITTER_ACCESS_TOKEN_2: ${{ secrets.TWITTER_ACCESS_TOKEN_2 }}
          TWITTER_ACCESS_TOKEN_SECRET_2: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET_2 }}

          # Configura√ß√£o do bot
          BACKLOG_DAYS: ${{ secrets.BACKLOG_DAYS }}
          MAX_TWEETS_PER_RUN: ${{ secrets.MAX_TWEETS_PER_RUN }}
          RATE_DELAY_SECONDS: ${{ secrets.RATE_DELAY_SECONDS }}
          RATE_BACKOFF_SECONDS: ${{ secrets.RATE_BACKOFF_SECONDS }}
          LOOP_MODE: ${{ secrets.LOOP_MODE }}
        run: |
          echo "üöÄ Executando o bot de publica√ß√£o..."
          python bot.py
